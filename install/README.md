# Installation

*install.sh* script has to be launch has root. It will procede to the installation of the backend and its dependencies. Password will be asked but can be generated by *makepasswd* (16 chars long by default) and will be consultable in **.env** file. 2 services will be created :
 - *arbalet.service* (backend)
 - *artnet.serve* (artnet provider)
and *systemd-resolved.service* will be disabled.

Sentry service is still to install manually as indicated below.

# Matomo initialisation

When the backend is started for the first time (or completely recreated), matomo service is still to configure. Open a web browser to [matomo.arbalet-project.org](matomo.arbalet-project.org). Follow the initialisation procedure (the prefilled information concerning mariadb are correct) and choose an admin login and password. Once it is done, add the site you want to follow in the next order :
 - live.arbalet-project.org
 - frontage.arbalet-project.org
 - application

 Ntd : if they are not set in the right order, you will recieved information comming from those site but they won't match their name in matomo entries. The first entry is live service, the second is the landing page and the last one is the app.
 
# Sentry config
```
cd Arbalet/frontage/sentry
docker-compose run --rm web config generate-secret-key
nano docker-compose.yml  # Add the Sentry's secret key to the environment file
docker-compose run --rm web upgrade # Build the database. Use the interactive prompts to create a user account.
```

* Open a web browser to [192.168.0.42:9000](192.168.0.42:9000) and login
* Set `Root URL [REQUIRED]` to http://192.168.0.42:9000 and some e-mail address
* Go to `New Project > Python > Project settings > Client Keys (DSN)` and paste the `DSN` **(PRIVATE)** in .env (back)
* Go to `New Project > Angular > Project settings > Client Keys (DSN)` and paste the `DSN (Public)` in `environment.ts` (front)

```
cd ../install
sudo cp sentry.service /lib/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable sentry.service

sudo reboot
```

# Manage services
```
sudo service arbalet stop
sudo service arbalet start
sudo systemctl status arbalet.service
sudo journalctl -u arbalet -f

```

```
cd prod
docker-compose run --rm app set_admin_credentials  # Change your admin password
docker-compose run --rm app reset  # Factory reset (Dropping DB)
```

# Troubleshooting
```
sqlalchemy.exc.OperationalError: (psycopg2.OperationalError) FATAL:  password authentication failed for user "some_suer"
```
First make sure `.env` has non-empty random passwords. In case the prod server is being reinstalled, make sure you destroy all the volumes `docker-compose down -v`. Also do not forget `-f` to specify the prod config.

# Internet

To access the Internet, arbalet service has to be stopped and systemd-resolved start. If its not enough, unplug the ethernet cable connected to the wifi access point and run dhclient to aquiere a valid IP.
